#!/bin/bash
# Chezmoi run_once script: Runs once per machine (tracked by script content hash)
# Install profile: {{ .profile }}

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}Installing packages for profile: {{ .profile }}${NC}"

{{ if eq .profile "minimal" -}}
# Minimal profile: Skip package installation
echo -e "${YELLOW}Minimal profile selected - skipping package installation${NC}"
echo "Shell configuration applied. Run chezmoi with profile=lite or profile=full for tools."
exit 0
{{ end -}}

{{ if eq .chezmoi.os "darwin" -}}
# macOS: Install via Homebrew
if ! command -v brew &>/dev/null; then
    echo -e "${BLUE}Installing Homebrew...${NC}"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    # Add brew to PATH for Apple Silicon
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

echo -e "${BLUE}Installing packages via Homebrew...${NC}"

# Taps
brew tap mikescher/tap 2>/dev/null || true
brew tap tako8ki/tap 2>/dev/null || true

# CLI Tools (all profiles except minimal)
brew install bat btop difftastic dust eza fastfetch fd fzf git-delta \
    lazydocker lazygit mikescher/tap/dops pgcli procs litecli mcat mycli \
    tako8ki/tap/gobang onefetch repomix treemd yazi starship tldr tmux zoxide \
    2>/dev/null || true

{{ if eq .profile "full" -}}
# Full profile: Add fonts and GUI apps
echo -e "${BLUE}Installing fonts and GUI apps (full profile)...${NC}"
brew install --cask font-fira-code-nerd-font wezterm visual-studio-code 2>/dev/null || true
brew install fileicon 2>/dev/null || true
{{ end -}}

{{ else if eq .chezmoi.os "linux" -}}
# Linux: Install via apt + manual downloads

# Ensure ~/.local/bin exists
mkdir -p "$HOME/.local/bin"
export PATH="$HOME/.local/bin:$PATH"

# Detect architecture
ARCH="$(uname -m)"

# Check for sudo access
SUDO=""
if [ "$EUID" -ne 0 ] && command -v sudo &>/dev/null && sudo -n true 2>/dev/null; then
    SUDO="sudo"
fi

# Install base packages via apt if we have sudo
if [ -n "$SUDO" ] || [ "$EUID" -eq 0 ]; then
    echo -e "${BLUE}Installing base packages via apt...${NC}"
    ${SUDO} apt update
    ${SUDO} apt install -y zsh git curl wget unzip tmux btop pgcli mycli litecli
else
    echo -e "${YELLOW}No sudo access - skipping apt packages (zsh, tmux, btop, pgcli, mycli, litecli)${NC}"
    echo -e "${YELLOW}These tools will need to be installed manually or by an admin${NC}"
fi

# Install starship
if ! command -v starship &>/dev/null; then
    echo -e "${BLUE}Installing starship...${NC}"
    curl -sS https://starship.rs/install.sh | sh -s -- -y
fi

# Install fzf
if ! command -v fzf &>/dev/null; then
    echo -e "${BLUE}Installing fzf...${NC}"
    git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf 2>/dev/null || true
    ~/.fzf/install --all --no-bash --no-fish 2>/dev/null || true
fi

# Install zoxide
if ! command -v zoxide &>/dev/null; then
    echo -e "${BLUE}Installing zoxide...${NC}"
    curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
fi

# Architecture-specific binaries
echo -e "${BLUE}Installing CLI tools for $ARCH...${NC}"

# Install eza
if ! command -v eza &>/dev/null; then
    EZA_VERSION=$(curl -s https://api.github.com/repos/eza-community/eza/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/eza-community/eza/releases/download/${EZA_VERSION}/eza_${ARCH}-unknown-linux-gnu.tar.gz" | tar xz -C "$HOME/.local/bin"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/eza-community/eza/releases/download/${EZA_VERSION}/eza_${ARCH}-unknown-linux-gnu.tar.gz" | tar xz -C "$HOME/.local/bin"
    fi
fi

# Install bat
if ! command -v bat &>/dev/null; then
    BAT_VERSION=$(curl -s https://api.github.com/repos/sharkdp/bat/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/sharkdp/bat/releases/download/${BAT_VERSION}/bat-${BAT_VERSION}-x86_64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "bat-${BAT_VERSION}-x86_64-unknown-linux-gnu/bat"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/sharkdp/bat/releases/download/${BAT_VERSION}/bat-${BAT_VERSION}-aarch64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "bat-${BAT_VERSION}-aarch64-unknown-linux-gnu/bat"
    fi
fi

# Install fd
if ! command -v fd &>/dev/null; then
    FD_VERSION=$(curl -s https://api.github.com/repos/sharkdp/fd/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/sharkdp/fd/releases/download/${FD_VERSION}/fd-${FD_VERSION}-x86_64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "fd-${FD_VERSION}-x86_64-unknown-linux-gnu/fd"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/sharkdp/fd/releases/download/${FD_VERSION}/fd-${FD_VERSION}-aarch64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "fd-${FD_VERSION}-aarch64-unknown-linux-gnu/fd"
    fi
fi

# Install dust
if ! command -v dust &>/dev/null; then
    DUST_VERSION=$(curl -s https://api.github.com/repos/bootandy/dust/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/bootandy/dust/releases/download/${DUST_VERSION}/dust-${DUST_VERSION}-x86_64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "dust-${DUST_VERSION}-x86_64-unknown-linux-gnu/dust"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/bootandy/dust/releases/download/${DUST_VERSION}/dust-${DUST_VERSION}-aarch64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "dust-${DUST_VERSION}-aarch64-unknown-linux-gnu/dust"
    fi
fi

# Install procs
if ! command -v procs &>/dev/null; then
    PROCS_VERSION=$(curl -s https://api.github.com/repos/dalance/procs/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/dalance/procs/releases/download/${PROCS_VERSION}/procs-${PROCS_VERSION}-x86_64-linux.zip" -o /tmp/procs.zip
        unzip -o /tmp/procs.zip -d "$HOME/.local/bin" && rm /tmp/procs.zip
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/dalance/procs/releases/download/${PROCS_VERSION}/procs-${PROCS_VERSION}-aarch64-linux.zip" -o /tmp/procs.zip
        unzip -o /tmp/procs.zip -d "$HOME/.local/bin" && rm /tmp/procs.zip
    fi
fi

# Install difftastic
if ! command -v difft &>/dev/null; then
    echo -e "${BLUE}Installing difftastic...${NC}"
    DIFFT_VERSION=$(curl -s https://api.github.com/repos/Wilfred/difftastic/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/Wilfred/difftastic/releases/download/${DIFFT_VERSION}/difft-x86_64-unknown-linux-gnu.tar.gz" | tar xz -C "$HOME/.local/bin"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/Wilfred/difftastic/releases/download/${DIFFT_VERSION}/difft-aarch64-unknown-linux-gnu.tar.gz" | tar xz -C "$HOME/.local/bin"
    fi
fi

# Install lazydocker
if ! command -v lazydocker &>/dev/null; then
    echo -e "${BLUE}Installing lazydocker...${NC}"
    LAZYDOCKER_VERSION=$(curl -s https://api.github.com/repos/jesseduffield/lazydocker/releases/latest | grep tag_name | cut -d'"' -f4 | sed 's/v//')
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/jesseduffield/lazydocker/releases/download/v${LAZYDOCKER_VERSION}/lazydocker_${LAZYDOCKER_VERSION}_Linux_x86_64.tar.gz" | tar xz -C "$HOME/.local/bin" lazydocker
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/jesseduffield/lazydocker/releases/download/v${LAZYDOCKER_VERSION}/lazydocker_${LAZYDOCKER_VERSION}_Linux_arm64.tar.gz" | tar xz -C "$HOME/.local/bin" lazydocker
    fi
fi

# Install lazygit
if ! command -v lazygit &>/dev/null; then
    echo -e "${BLUE}Installing lazygit...${NC}"
    LAZYGIT_VERSION=$(curl -s https://api.github.com/repos/jesseduffield/lazygit/releases/latest | grep tag_name | cut -d'"' -f4 | sed 's/v//')
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" | tar xz -C "$HOME/.local/bin" lazygit
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Linux_arm64.tar.gz" | tar xz -C "$HOME/.local/bin" lazygit
    fi
fi

# Install dops (docker ps replacement)
if ! command -v dops &>/dev/null; then
    echo -e "${BLUE}Installing dops...${NC}"
    DOPS_VERSION=$(curl -s https://api.github.com/repos/Mikescher/better-docker-ps/releases/latest | grep tag_name | cut -d'"' -f4 | sed 's/v//')
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/Mikescher/better-docker-ps/releases/download/v${DOPS_VERSION}/dops_linux-amd64" -o "$HOME/.local/bin/dops"
        chmod +x "$HOME/.local/bin/dops"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/Mikescher/better-docker-ps/releases/download/v${DOPS_VERSION}/dops_linux-arm64" -o "$HOME/.local/bin/dops"
        chmod +x "$HOME/.local/bin/dops"
    fi
fi

# Install delta
if ! command -v delta &>/dev/null; then
    DELTA_VERSION=$(curl -s https://api.github.com/repos/dandavison/delta/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/dandavison/delta/releases/download/${DELTA_VERSION}/delta-${DELTA_VERSION}-x86_64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "delta-${DELTA_VERSION}-x86_64-unknown-linux-gnu/delta"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/dandavison/delta/releases/download/${DELTA_VERSION}/delta-${DELTA_VERSION}-aarch64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "delta-${DELTA_VERSION}-aarch64-unknown-linux-gnu/delta"
    fi
fi

# Install fastfetch
if ! command -v fastfetch &>/dev/null; then
    echo -e "${BLUE}Installing fastfetch...${NC}"
    FASTFETCH_VERSION=$(curl -s https://api.github.com/repos/fastfetch-cli/fastfetch/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/fastfetch-cli/fastfetch/releases/download/${FASTFETCH_VERSION}/fastfetch-linux-amd64.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "fastfetch-linux-amd64/usr/bin/fastfetch"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/fastfetch-cli/fastfetch/releases/download/${FASTFETCH_VERSION}/fastfetch-linux-aarch64.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "fastfetch-linux-aarch64/usr/bin/fastfetch"
    fi
fi

# Install tldr (tealdeer - fast tldr client)
if ! command -v tldr &>/dev/null; then
    echo -e "${BLUE}Installing tldr...${NC}"
    TLDR_VERSION=$(curl -s https://api.github.com/repos/dbrgn/tealdeer/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/dbrgn/tealdeer/releases/download/${TLDR_VERSION}/tealdeer-linux-x86_64-musl" -o "$HOME/.local/bin/tldr"
        chmod +x "$HOME/.local/bin/tldr"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/dbrgn/tealdeer/releases/download/${TLDR_VERSION}/tealdeer-linux-aarch64-musl" -o "$HOME/.local/bin/tldr"
        chmod +x "$HOME/.local/bin/tldr"
    fi
fi

# Install onefetch (x86_64 only has pre-built binary, aarch64 needs cargo)
if ! command -v onefetch &>/dev/null; then
    echo -e "${BLUE}Installing onefetch...${NC}"
    if [ "$ARCH" = "x86_64" ]; then
        ONEFETCH_VERSION=$(curl -s https://api.github.com/repos/o2sh/onefetch/releases/latest | grep tag_name | cut -d'"' -f4)
        curl -sL "https://github.com/o2sh/onefetch/releases/download/${ONEFETCH_VERSION}/onefetch-linux.tar.gz" | tar xz -C "$HOME/.local/bin" onefetch
    elif [ "$ARCH" = "aarch64" ]; then
        if command -v cargo &>/dev/null; then
            cargo install onefetch || echo -e "${YELLOW}Failed to install onefetch via cargo${NC}"
        else
            echo -e "${YELLOW}onefetch: no pre-built aarch64 binary, cargo not available${NC}"
        fi
    fi
fi

# Install yazi
if ! command -v yazi &>/dev/null; then
    echo -e "${BLUE}Installing yazi...${NC}"
    YAZI_VERSION=$(curl -s https://api.github.com/repos/sxyazi/yazi/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/sxyazi/yazi/releases/download/${YAZI_VERSION}/yazi-x86_64-unknown-linux-gnu.zip" -o /tmp/yazi.zip
        unzip -o /tmp/yazi.zip -d /tmp && mv /tmp/yazi-x86_64-unknown-linux-gnu/yazi "$HOME/.local/bin/" && rm -rf /tmp/yazi.zip /tmp/yazi-x86_64-unknown-linux-gnu
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/sxyazi/yazi/releases/download/${YAZI_VERSION}/yazi-aarch64-unknown-linux-gnu.zip" -o /tmp/yazi.zip
        unzip -o /tmp/yazi.zip -d /tmp && mv /tmp/yazi-aarch64-unknown-linux-gnu/yazi "$HOME/.local/bin/" && rm -rf /tmp/yazi.zip /tmp/yazi-aarch64-unknown-linux-gnu
    fi
fi

# Install repomix via npm (if npm is available)
if ! command -v repomix &>/dev/null; then
    if command -v npm &>/dev/null; then
        echo -e "${BLUE}Installing repomix via npm...${NC}"
        npm install -g repomix || echo -e "${YELLOW}Failed to install repomix${NC}"
    else
        echo -e "${YELLOW}npm not found - skipping repomix${NC}"
    fi
fi

# Install Rust-based tools via cargo (if cargo is available)
if command -v cargo &>/dev/null; then
    echo -e "${BLUE}Installing Rust-based tools via cargo...${NC}"

    # mcat - markdown cat
    if ! command -v mcat &>/dev/null; then
        echo -e "${BLUE}Installing mcat...${NC}"
        cargo install mcat || echo -e "${YELLOW}Failed to install mcat${NC}"
    fi

    # treemd - markdown tree generator
    if ! command -v treemd &>/dev/null; then
        echo -e "${BLUE}Installing treemd...${NC}"
        cargo install treemd || echo -e "${YELLOW}Failed to install treemd${NC}"
    fi

    # gobang - database TUI
    if ! command -v gobang &>/dev/null; then
        echo -e "${BLUE}Installing gobang...${NC}"
        cargo install gobang --version 0.1.0-alpha.5 || echo -e "${YELLOW}Failed to install gobang${NC}"
    fi
else
    echo -e "${YELLOW}cargo not found - skipping Rust tools (mcat, treemd, gobang)${NC}"
    echo -e "${YELLOW}Install Rust via: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh${NC}"
fi

{{ end -}}

echo -e "${GREEN}Package installation complete!${NC}"
