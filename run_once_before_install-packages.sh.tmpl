#!/bin/bash
# Chezmoi run_once script: Runs once per machine (tracked by script content hash)
# Install profile: {{ .profile }}

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}Installing packages for profile: {{ .profile }}${NC}"

{{ if eq .profile "minimal" -}}
# Minimal profile: Skip package installation
echo -e "${YELLOW}Minimal profile selected - skipping package installation${NC}"
echo "Shell configuration applied. Run chezmoi with profile=lite or profile=full for tools."
exit 0
{{ end -}}

{{ if eq .chezmoi.os "darwin" -}}
# macOS: Install via Homebrew
if ! command -v brew &>/dev/null; then
    echo -e "${BLUE}Installing Homebrew...${NC}"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    # Add brew to PATH for Apple Silicon
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

echo -e "${BLUE}Installing packages via Homebrew...${NC}"

# Taps
brew tap mikescher/tap 2>/dev/null || true
brew tap tako8ki/tap 2>/dev/null || true

# CLI Tools (all profiles except minimal)
brew install bat btop difftastic dust eza fastfetch fd fzf git-delta \
    lazydocker mikescher/tap/dops pgcli procs litecli mcat mycli \
    tako8ki/tap/gobang onefetch repomix treemd yazi starship tldr tmux zoxide \
    2>/dev/null || true

{{ if eq .profile "full" -}}
# Full profile: Add fonts and GUI apps
echo -e "${BLUE}Installing fonts and GUI apps (full profile)...${NC}"
brew install --cask font-fira-code-nerd-font wezterm visual-studio-code 2>/dev/null || true
brew install fileicon 2>/dev/null || true
{{ end -}}

{{ else if eq .chezmoi.os "linux" -}}
# Linux: Install via apt + manual downloads

# Ensure ~/.local/bin exists
mkdir -p "$HOME/.local/bin"
export PATH="$HOME/.local/bin:$PATH"

# Detect architecture
ARCH="$(uname -m)"

# Check for sudo access
SUDO=""
if [ "$EUID" -ne 0 ] && command -v sudo &>/dev/null && sudo -n true 2>/dev/null; then
    SUDO="sudo"
fi

# Install base packages via apt if we have sudo
if [ -n "$SUDO" ] || [ "$EUID" -eq 0 ]; then
    echo -e "${BLUE}Installing base packages via apt...${NC}"
    ${SUDO} apt update
    ${SUDO} apt install -y zsh git curl wget unzip
fi

# Install starship
if ! command -v starship &>/dev/null; then
    echo -e "${BLUE}Installing starship...${NC}"
    curl -sS https://starship.rs/install.sh | sh -s -- -y
fi

# Install fzf
if ! command -v fzf &>/dev/null; then
    echo -e "${BLUE}Installing fzf...${NC}"
    git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf 2>/dev/null || true
    ~/.fzf/install --all --no-bash --no-fish 2>/dev/null || true
fi

# Install zoxide
if ! command -v zoxide &>/dev/null; then
    echo -e "${BLUE}Installing zoxide...${NC}"
    curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
fi

# Architecture-specific binaries
echo -e "${BLUE}Installing CLI tools for $ARCH...${NC}"

# Install eza
if ! command -v eza &>/dev/null; then
    EZA_VERSION=$(curl -s https://api.github.com/repos/eza-community/eza/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/eza-community/eza/releases/download/${EZA_VERSION}/eza_${ARCH}-unknown-linux-gnu.tar.gz" | tar xz -C "$HOME/.local/bin"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/eza-community/eza/releases/download/${EZA_VERSION}/eza_${ARCH}-unknown-linux-gnu.tar.gz" | tar xz -C "$HOME/.local/bin"
    fi
fi

# Install bat
if ! command -v bat &>/dev/null; then
    BAT_VERSION=$(curl -s https://api.github.com/repos/sharkdp/bat/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/sharkdp/bat/releases/download/${BAT_VERSION}/bat-${BAT_VERSION}-x86_64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "bat-${BAT_VERSION}-x86_64-unknown-linux-gnu/bat"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/sharkdp/bat/releases/download/${BAT_VERSION}/bat-${BAT_VERSION}-aarch64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "bat-${BAT_VERSION}-aarch64-unknown-linux-gnu/bat"
    fi
fi

# Install fd
if ! command -v fd &>/dev/null; then
    FD_VERSION=$(curl -s https://api.github.com/repos/sharkdp/fd/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/sharkdp/fd/releases/download/${FD_VERSION}/fd-${FD_VERSION}-x86_64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "fd-${FD_VERSION}-x86_64-unknown-linux-gnu/fd"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/sharkdp/fd/releases/download/${FD_VERSION}/fd-${FD_VERSION}-aarch64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "fd-${FD_VERSION}-aarch64-unknown-linux-gnu/fd"
    fi
fi

# Install dust
if ! command -v dust &>/dev/null; then
    DUST_VERSION=$(curl -s https://api.github.com/repos/bootandy/dust/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/bootandy/dust/releases/download/${DUST_VERSION}/dust-${DUST_VERSION}-x86_64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "dust-${DUST_VERSION}-x86_64-unknown-linux-gnu/dust"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/bootandy/dust/releases/download/${DUST_VERSION}/dust-${DUST_VERSION}-aarch64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "dust-${DUST_VERSION}-aarch64-unknown-linux-gnu/dust"
    fi
fi

# Install procs
if ! command -v procs &>/dev/null; then
    PROCS_VERSION=$(curl -s https://api.github.com/repos/dalance/procs/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/dalance/procs/releases/download/${PROCS_VERSION}/procs-${PROCS_VERSION}-x86_64-linux.zip" -o /tmp/procs.zip
        unzip -o /tmp/procs.zip -d "$HOME/.local/bin" && rm /tmp/procs.zip
    fi
fi

# Install delta
if ! command -v delta &>/dev/null; then
    DELTA_VERSION=$(curl -s https://api.github.com/repos/dandavison/delta/releases/latest | grep tag_name | cut -d'"' -f4)
    if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/dandavison/delta/releases/download/${DELTA_VERSION}/delta-${DELTA_VERSION}-x86_64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "delta-${DELTA_VERSION}-x86_64-unknown-linux-gnu/delta"
    elif [ "$ARCH" = "aarch64" ]; then
        curl -sL "https://github.com/dandavison/delta/releases/download/${DELTA_VERSION}/delta-${DELTA_VERSION}-aarch64-unknown-linux-gnu.tar.gz" | tar xz --strip-components=1 -C "$HOME/.local/bin" "delta-${DELTA_VERSION}-aarch64-unknown-linux-gnu/delta"
    fi
fi

{{ end -}}

echo -e "${GREEN}Package installation complete!${NC}"
