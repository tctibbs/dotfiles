#!/bin/bash
# Chezmoi run_onchange script: Re-runs when this script's content changes
# Installs TPM and tmux plugins

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

{{ if eq .profile "minimal" -}}
echo -e "${YELLOW}Minimal profile - skipping tmux plugin setup${NC}"
exit 0
{{ end -}}

# Check if tmux is installed
if ! command -v tmux &>/dev/null; then
    echo -e "${YELLOW}tmux not found - skipping plugin setup${NC}"
    exit 0
fi

echo -e "${BLUE}Setting up tmux plugins...${NC}"

TMUX_PLUGINS_DIR="$HOME/.tmux/plugins"
mkdir -p "$TMUX_PLUGINS_DIR"

# Install TPM (Tmux Plugin Manager)
TPM_DIR="$TMUX_PLUGINS_DIR/tpm"
if [ ! -d "$TPM_DIR" ]; then
    echo -e "${BLUE}Installing Tmux Plugin Manager (TPM)...${NC}"
    git clone --quiet https://github.com/tmux-plugins/tpm "$TPM_DIR"
    echo -e "${GREEN}TPM installed${NC}"
else
    echo -e "${GREEN}TPM already installed${NC}"
fi

# Install plugins directly (same as configured in .tmux.conf)
echo -e "${BLUE}Installing tmux plugins...${NC}"

declare -A PLUGINS=(
    ["tmux-sensible"]="https://github.com/tmux-plugins/tmux-sensible"
    ["tmux-resurrect"]="https://github.com/tmux-plugins/tmux-resurrect"
    ["tmux-continuum"]="https://github.com/tmux-plugins/tmux-continuum"
    ["tmux-yank"]="https://github.com/tmux-plugins/tmux-yank"
    ["tmux-fzf"]="https://github.com/sainnhe/tmux-fzf"
    ["tmux-sessionx"]="https://github.com/omerxx/tmux-sessionx"
    ["tmux2k"]="https://github.com/2KAbhishek/tmux2k"
    ["tmux-tpad"]="https://github.com/Subbeh/tmux-tpad"
)

for plugin in "${!PLUGINS[@]}"; do
    PLUGIN_DIR="$TMUX_PLUGINS_DIR/$plugin"
    if [ ! -d "$PLUGIN_DIR" ]; then
        echo "  Installing $plugin..."
        git clone --quiet "${PLUGINS[$plugin]}" "$PLUGIN_DIR"
    else
        echo "  $plugin already installed"
    fi
done

echo -e "${GREEN}Tmux plugin setup complete!${NC}"
echo "Run 'tmux source ~/.tmux.conf' or restart tmux to load plugins."
