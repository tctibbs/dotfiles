# Tmux Configuration
# ===================

# ===================================
# Core Settings
# ===================================

# Set prefix key to Ctrl-a instead of Ctrl-b
unbind C-b
set-option -g prefix C-a

# Unbind C-a to prevent sending literal ^A
unbind C-a

# Use prefix + Ctrl-a to send literal ^A when needed (for nested tmux/screen)
bind C-a send-prefix

# Enable mouse support
set -g mouse on

# Set default terminal mode with true color and UTF-8 support
set -g default-terminal "tmux-256color"
set-option -ga terminal-overrides ",xterm-256color:Tc"
set -q -g status-utf8 on

# Increase scrollback buffer size
set -g history-limit 10000

# Start window and pane indices at 1
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when a window is closed
set -g renumber-windows on

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity off

# Enable vi mode for copy mode
setw -g mode-keys vi

# Reduce escape time for better vim experience
set -sg escape-time 0

# Focus events enabled for terminals that support them
set -g focus-events on

# Automatic window rename (disabled - cwd shown in status bar left)
set -g automatic-rename off

# Don't exit from tmux when closing a session
set -g exit-empty on

# Allow programs to change window names
set -g allow-rename off

# Aggressive resize (useful when multiple clients)
setw -g aggressive-resize on

# Increase repeat time for repeatable commands
set -g repeat-time 1000

# ===================================
# OS-Specific Configuration
# ===================================

# Load macOS-specific settings (clipboard, iTerm2)
if-shell "uname | grep -q Darwin" "source-file ~/.tmux.mac.conf"

# Load Linux-specific settings (xclip, wl-copy, WSL2)
if-shell "uname | grep -q Linux" "source-file ~/.tmux.linux.conf"

# ===================================
# Key Bindings
# ===================================

# Reload tmux config with r
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# Split panes using | and -
unbind '"'
unbind %
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# New window in current path
bind c new-window -c "#{pane_current_path}"

# Switch panes using Alt+arrow without prefix
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Switch windows using Alt+number
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5

# Resize panes with Alt+Shift+arrows
bind -n M-S-Left resize-pane -L 5
bind -n M-S-Right resize-pane -R 5
bind -n M-S-Up resize-pane -U 5
bind -n M-S-Down resize-pane -D 5

# Vi-style copy mode bindings
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle

# ===================================
# Popup Shortcuts (native tmux fallbacks)
# ===================================

# LazyGit popup (prefix + g) - opens in current pane's directory
bind g display-popup -E -w 85% -h 85% -d "#{pane_current_path}" "lazygit"

# Claude AI popup (prefix + a)
bind a display-popup -E -w 80% -h 80% -d "#{pane_current_path}" "claude --dangerously-skip-permissions"

# btop popup (prefix + b)
bind b display-popup -E -w 90% -h 90% "btop"

# Notes popup (prefix + n) - opens nano for quick notes
bind n display-popup -E -w 70% -h 70% "nano ~/.tmux-notes.md"

# Alt: Claude popup (prefix + Ctrl-c)
bind C-c display-popup -E -w 80% -h 80% -d "#{pane_current_path}" "claude --dangerously-skip-permissions"

# ===================================
# Screensaver / Idle Lock
# ===================================

# Auto-lock disabled (use prefix + L for manual screensaver)
set -g lock-after-time 0

# Manual screensaver popup (prefix + L) - press q or Ctrl-c to exit
bind L display-popup -E -w 100% -h 100% "cmatrix -b -s 2>/dev/null || pipes.sh 2>/dev/null || htop"

# ===================================
# Pane Styling (Catppuccin Mocha)
# ===================================

# Pane border colors
set -g pane-border-style 'fg=#6c7086'
set -g pane-active-border-style 'fg=#89b4fa'

# Clock mode colors
setw -g clock-mode-colour '#89b4fa'
setw -g clock-mode-style 24

# Copy mode colors
setw -g mode-style 'bg=#89b4fa,fg=#1e1e2e'

# Message styling
set -g message-style 'bg=#f38ba8,fg=#1e1e2e,bold'
set -g message-command-style 'bg=#f9e2af,fg=#1e1e2e,bold'

# ===================================
# Plugins (TPM)
# ===================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'

# Session Management
set -g @plugin 'omerxx/tmux-sessionx'
set -g @sessionx-bind 's'
set -g @sessionx-zoxide-mode 'on'

# Status Bar
set -g @plugin '2KAbhishek/tmux2k'
set -g @tmux2k-theme 'catppuccin'
set -g @tmux2k-icons-only false
set -g @tmux2k-left-plugins "cwd git cpu ram"
set -g @tmux2k-right-plugins "battery network time"
set -g @tmux2k-military-time true
set -g @tmux2k-start-icon ""
set -g @tmux2k-refresh-rate 5
set -g @tmux2k-prefix-highlight '#f38ba8'
set -g @tmux2k-cwd-length 20

# Override icons for Fira Code Nerd Font
set -g @tmux2k-cwd-icon "󰉋"
set -g @tmux2k-git-repo-icon ""
set -g @tmux2k-cpu-icon "󰍛"
set -g @tmux2k-ram-icon "󰘚"

# Floating Scratchpads
set -g @plugin 'Subbeh/tmux-tpad'

# LazyGit popup (prefix + g)
set -g @tpad-lazygit-bind "g"
set -g @tpad-lazygit-cmd "lazygit"
set -g @tpad-lazygit-width "85%"
set -g @tpad-lazygit-height "85%"
set -g @tpad-lazygit-dir "#{pane_current_path}"
set -g @tpad-lazygit-per-dir "true"

# AI Assistant popup (prefix + a)
set -g @tpad-ai-bind "a"
set -g @tpad-ai-cmd "claude --dangerously-skip-permissions"
set -g @tpad-ai-width "80%"
set -g @tpad-ai-height "80%"
set -g @tpad-ai-dir "#{pane_current_path}"

# System monitor popup (prefix + b)
set -g @tpad-btop-bind "b"
set -g @tpad-btop-cmd "btop"
set -g @tpad-btop-width "90%"
set -g @tpad-btop-height "90%"

# Notes scratchpad (prefix + n)
set -g @tpad-notes-bind "n"
set -g @tpad-notes-cmd "nano ~/.tmux-notes.md"
set -g @tpad-notes-width "70%"
set -g @tpad-notes-height "70%"

# Fuzzy Finder
set -g @plugin 'sainnhe/tmux-fzf'
set -g @tmux-fzf-launch-key 'f'

# Session Persistence
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Resurrect settings
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# Continuum settings
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# ===================================
# TPM Initialization
# ===================================

run '~/.tmux/plugins/tpm/tpm'

# ===================================
# Post-TPM Customizations (MUST BE AFTER TPM)
# ===================================

# Hide center window list (cwd already shown in left status)
set -g window-status-format ''
set -g window-status-current-format ''

# Append prefix indicator to status-right
set -g status-right-length 200
set -ga status-right "#{?client_prefix, #[bg=#f38ba8]#[fg=#1e1e2e]#[bold] ^A #[default],}"
